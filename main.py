import streamlit as st
import fitz  # PyMuPDF
import io

def process_pdf(doc):
    """
    PDF ë¬¸ì„œì˜ ëª¨ë“  í˜ì´ì§€ë¥¼ ìˆœíšŒí•˜ë©° ê°œì¸ì •ë³´ë¥¼ ì œê±°í•©ë‹ˆë‹¤.
    ë‘ ê°€ì§€ ë°©ì‹(í…ìŠ¤íŠ¸ ê²€ìƒ‰, ê³ ì • ì¢Œí‘œ)ì„ ëª¨ë‘ ì‚¬ìš©í•©ë‹ˆë‹¤.
    """

    # --- 1. í…ìŠ¤íŠ¸ ê²€ìƒ‰ ê¸°ë°˜ ì‚­ì œ ë¡œì§ ("ê³ ë“±í•™êµ" ë¬¸êµ¬) ---
    # ëª¨ë“  í˜ì´ì§€ë¥¼ ìˆœíšŒí•˜ë©° "ê³ ë“±í•™êµ"ë¼ëŠ” í…ìŠ¤íŠ¸ë¥¼ ê²€ìƒ‰í•˜ì—¬ í°ìƒ‰ìœ¼ë¡œ ë®ìŠµë‹ˆë‹¤.
    # ì´ëŠ” 'ìˆ˜ìƒê²½ë ¥', 'ë´‰ì‚¬í™œë™ì‹¤ì ' í‘œ ë‚´ì˜ í•™êµëª… ë° í•˜ë‹¨ í‘¸í„°ì˜ í•™êµëª…ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
    for page in doc:
        try:
            # "ê³ ë“±í•™êµ" í…ìŠ¤íŠ¸ê°€ í¬í•¨ëœ ëª¨ë“  ìœ„ì¹˜ (Rect ê°ì²´ ë¦¬ìŠ¤íŠ¸)ë¥¼ ì°¾ìŠµë‹ˆë‹¤.
            text_instances = page.search_for("ê³ ë“±í•™êµ")
            
            # ì°¾ì€ ëª¨ë“  í…ìŠ¤íŠ¸ ì˜ì—­ì„ í°ìƒ‰ ì‚¬ê°í˜•ìœ¼ë¡œ ë®ìŠµë‹ˆë‹¤.
            for inst in text_instances:
                # fill: ì±„ìš°ê¸° ìƒ‰ (1, 1, 1) = í°ìƒ‰
                # overlay=True: ê¸°ì¡´ ë‚´ìš© ìœ„ì— ë®ì–´ì“°ê¸°
                page.draw_rect(inst, color=(1, 1, 1), fill=(1, 1, 1), overlay=True)
        except Exception as e:
            st.warning(f"{page.number + 1}í˜ì´ì§€ í…ìŠ¤íŠ¸ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜: {e}")

    # --- 2. ê³ ì • ì¢Œí‘œ ê¸°ë°˜ ì˜ì—­ ì‚­ì œ ë¡œì§ ---
    
    # --- 2-1. 1í˜ì´ì§€ ìƒë‹¨ ë° ì¸ì ì‚¬í•­ (ê³ ì • ì˜ì—­) ---
    if len(doc) > 0:
        page1 = doc[0]
        try:
            # 1í˜ì´ì§€ ìƒë‹¨ ì²« ë²ˆì§¸ í‘œ (ì‚¬ì§„, ë°˜, ë²ˆí˜¸, ë‹´ì„ì„±ëª… ë‚´ìš©)
            # ì‚¬ì§„ ì˜ì—­ (ì¢Œí‘œ: x0, y0, x1, y1)
            page1.draw_rect(fitz.Rect(435, 30, 555, 170), color=(1, 1, 1), fill=(1, 1, 1))
            # 1-3í•™ë…„ ë°˜, ë²ˆí˜¸, ë‹´ì„ ë‚´ìš© ì˜ì—­ (í‘œ í…Œë‘ë¦¬ëŠ” ë‚¨ê¹€)
            page1.draw_rect(fitz.Rect(350, 99, 555, 144), color=(1, 1, 1), fill=(1, 1, 1))

            # 1í˜ì´ì§€ ë‘ ë²ˆì§¸ í‘œ (1. ì¸ì Â·í•™ì ì‚¬í•­ ë‚´ìš©)
            # ì„±ëª…, ì„±ë³„, ì£¼ë¯¼ë²ˆí˜¸ ë‚´ìš© ì˜ì—­
            page1.draw_rect(fitz.Rect(100, 188, 555, 203), color=(1, 1, 1), fill=(1, 1, 1))
            # ì£¼ì†Œ ë‚´ìš© ì˜ì—­
            page1.draw_rect(fitz.Rect(100, 203, 555, 218), color=(1, 1, 1), fill=(1, 1, 1))
            # í•™ì ì‚¬í•­ ë‚´ìš© ì˜ì—­
            page1.draw_rect(fitz.Rect(100, 225, 555, 255), color=(1, 1, 1), fill=(1, 1, 1))
            # íŠ¹ê¸°ì‚¬í•­ ë‚´ìš© ì˜ì—­
            page1.draw_rect(fitz.Rect(100, 260, 555, 275), color=(1, 1, 1), fill=(1, 1, 1))
        
        except Exception as e:
            st.error(f"1í˜ì´ì§€ ê³ ì • ì˜ì—­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: {e}")

    # --- 2-2. ëª¨ë“  í˜ì´ì§€ ë§¨ í•˜ë‹¨ (ê³ ì • ì˜ì—­) ---
    for page in doc:
        try:
            page_rect = page.rect  # í˜ì´ì§€ì˜ ì „ì²´ í¬ê¸° (width, height)
            
            # í•˜ë‹¨ ì¤‘ì•™ì˜ í˜ì´ì§€ ë²ˆí˜¸ëŠ” ë‚¨ê²¨ë‘ê³ ,
            # ì˜¤ë¥¸ìª½ì˜ 'ë°˜, ë²ˆí˜¸, ì„±ëª…' í‘œ ì „ì²´ë¥¼ ë®ìŠµë‹ˆë‹¤. (Xì¢Œí‘œ 370ë¶€í„° ëê¹Œì§€)
            # (Yì¢Œí‘œëŠ” ì¼ë°˜ì ì¸ A4 í•˜ë‹¨ ê¸°ì¤€)
            footer_table_rect = fitz.Rect(370, 790, page_rect.width, 815)
            page.draw_rect(footer_table_rect, color=(1, 1, 1), fill=(1, 1, 1))
            
            # ë§¨ ì•„ë˜ì˜ ì¶”ê°€ì ì¸ ì‹ë³„ ë¼ì¸(ì˜ˆ: '.../ë‹´ì„êµì‚¬ëª…')ì´ ìˆë‹¤ë©´ ë®ìŠµë‹ˆë‹¤.
            # Yì¢Œí‘œ 816ë¶€í„° í˜ì´ì§€ ëê¹Œì§€
            bottom_line_rect = fitz.Rect(0, 816, page_rect.width, page_rect.height)
            page.draw_rect(bottom_line_rect, color=(1, 1, 1), fill=(1, 1, 1))

        except Exception as e:
            st.warning(f"{page.number + 1}í˜ì´ì§€ í•˜ë‹¨ ì˜ì—­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: {e}")

    return doc

# --- Streamlit ì•± UI êµ¬ì„± ---

st.set_page_config(page_title="PDF ê°œì¸ì •ë³´ ë³´í˜¸ ì²˜ë¦¬", layout="centered")
st.title("PDF ê°œì¸ì •ë³´ ë³´í˜¸ ì²˜ë¦¬ê¸° ğŸ”’")
st.write("í•™êµìƒí™œê¸°ë¡ë¶€ PDFë¥¼ ì—…ë¡œë“œí•˜ë©´ ë¯¼ê° ì •ë³´(ì„±ëª…, ì£¼ë¯¼ë²ˆí˜¸, ì£¼ì†Œ, í•™êµëª… ë“±)ë¥¼ í°ìƒ‰ìœ¼ë¡œ ë®ì–´ ì²˜ë¦¬í•©ë‹ˆë‹¤.")

uploaded_file = st.file_uploader("ì—¬ê¸°ì— PDF íŒŒì¼ì„ ë“œë˜ê·¸ ì•¤ ë“œë¡­í•˜ì„¸ìš”.", type="pdf")

if uploaded_file is not None:
    try:
        # 1. íŒŒì¼ ì½ê¸°
        pdf_bytes = uploaded_file.getvalue()
        doc = fitz.open(stream=pdf_bytes, filetype="pdf")
        
        st.info(f"ì´ {len(doc)}í˜ì´ì§€ì˜ PDF íŒŒì¼ì„ ì„±ê³µì ìœ¼ë¡œ ì½ì—ˆìŠµë‹ˆë‹¤. ê°œì¸ì •ë³´ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤...")

        # 2. PDF ì²˜ë¦¬ í•¨ìˆ˜ í˜¸ì¶œ
        processed_doc = process_pdf(doc)

        # 3. ì²˜ë¦¬ëœ PDFë¥¼ ë©”ëª¨ë¦¬ì— ì €ì¥
        output_bytes = processed_doc.tobytes()
        processed_doc.close()
        
        st.success("âœ… ê°œì¸ì •ë³´ ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”.")

        # 4. ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ì œê³µ
        st.download_button(
            label="ì²˜ë¦¬ëœ 'ì œê±°ë¨.pdf' íŒŒì¼ ë‹¤ìš´ë¡œë“œ",
            data=output_bytes,
            file_name="ì œê±°ë¨.pdf",
            mime="application/pdf"
        )
    except Exception as e:
        st.error(f"PDF ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")
        st.warning("íŒŒì¼ì´ ì†ìƒë˜ì—ˆê±°ë‚˜ ì•”í˜¸í™”ë˜ì–´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ íŒŒì¼ì„ ì‹œë„í•´ ì£¼ì„¸ìš”.")

else:
    st.info("PDF íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ ì²˜ë¦¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.")
